<?xml version="1.0" encoding="utf-8"?>
<Randomevents>
  <!-- Events defined in <EventPrefabs> can only be triggered via a console command or with a TriggerEventAction -->
  <EventPrefabs>
  
    <!-- Pirate Broadcast during pirate missions -->
    <ScriptedEvent identifier="piratemissionbroadcast">
      <TagAction criteria="humanprefabidentifier:piratecaptain" tag="transmitter" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="humanprefabidentifier:piratecaptainlord" tag="transmitter" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="player" tag="player" />
      <TriggerAction target1tag="player" target2tag="transmitter" applytotarget1="listener" radius="25000" disableincombat="false" disableiftargetincapacitated="true" waitforinteraction="false" allowmultipletargets="true" />
      <StatusEffectAction targettag="listener">
        <StatusEffect target="NearbyItems" tags="commsrelay" duration="10.2">
          <Sound file="%ModDir:2532991202%/Sounds/Events/PirateBroadcast.ogg" volume="1" loop="true" />
        </StatusEffect>
      </StatusEffectAction>
      <ConversationAction text="eventtext.piratemissionbroadcast.receive" targettag="listener" waitforinteraction="false" dialogtype="small" />
      <ClearTagAction tag="listener" />
    </ScriptedEvent>
    
    <!-- Coalition Cargo Vessel -->
    <ScriptedEvent identifier="cocargobroadcast">
      <TagAction criteria="humanprefabidentifier:coalitioncaptain" tag="transmitter" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="humanprefabidentifier:coalitioncaptainlord" tag="transmitter" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="humanprefabidentifier:coalitioncaptain" tag="coalitionnpc" />
      <TagAction criteria="humanprefabidentifier:coalitioncaptainlord" tag="coalitionnpc" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="humanprefabidentifier:coalitionsecurityrecruit" tag="coalitionnpc" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="humanprefabidentifier:coalitionsecuritygunner" tag="coalitionnpc" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="humanprefabidentifier:coalitionsecuritybrute" tag="coalitionnpc" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="humanprefabidentifier:coalitionsecurityelite" tag="coalitionnpc" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="humanprefabidentifier:coalitionmechanicrecruit" tag="coalitionnpc" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="humanprefabidentifier:coalitionmechanicveteran" tag="coalitionnpc" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="humanprefabidentifier:coalitionengineerrecruit" tag="coalitionnpc" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="humanprefabidentifier:coalitionengineerveteran" tag="coalitionnpc" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="itemidentifier:navterminal" tag="receiver" submarinetype="player" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="player" tag="player" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="itemtag:coalitioncargo" tag="coalitioncargo" ContinueIfNoTargetsFound="true" />
      <StatusEffectAction targettag="coalitioncargo">
        <StatusEffect target="This" SpawnedInCurrentOutpost="true" AllowStealing="false" setvalue="true"/>
      </StatusEffectAction>
      <TriggerAction target1tag="receiver" target2tag="transmitter" radius="25000" disableincombat="false" disableiftargetincapacitated="true" waitforinteraction="false" allowmultipletargets="true" />
      <TriggerAction target1tag="player" target2tag="receiver" applytotarget1="listener_player" radius="300" disableincombat="false" disableiftargetincapacitated="true" waitforinteraction="true" allowmultipletargets="false" />
      <ConversationAction text="eventtext.cocargobroadcast.receive" targettag="listener_player" waitforinteraction="true" dialogtype="small">
        <Option text="eventtext.option.listen">
          <NPCChangeTeamAction npctag="coalitionnpc" teamtag="FriendlyNPC" />
          <StatusEffectAction targettag="listener_player">
            <StatusEffect target="NearbyItems" tags="commsrelay" duration="10.2">
              <Sound file="%ModDir:2532991202%/Sounds/Events/CoalitionBroadcast.ogg" volume="1" loop="true" />
            </StatusEffect>
          </StatusEffectAction>
          <ConversationAction text="eventtext.cocargobroadcast.receive.accept.answer" targettag="listener_player" dialogtype="small">
            <Option text="eventtext.cocargobroadcast.receive.accept.answer.truth">
              <NPCChangeTeamAction npctag="coalitionnpc" teamtag="Team2" />
              <ConversationAction text="eventtext.cocargobroadcast.receive.accept.answer.truth.answer" targettag="listener_player" dialogtype="small" />
              <ClearTagAction tag="listener_player" />
            </Option>
            <Option text="eventtext.cocargobroadcast.receive.accept.answer.lie">
              <SkillCheckAction requiredskill="helm" requiredlevel="80" probabilitybased="false" targettag="listener_player">
                <Success>
                  <RNGAction chance="0.75">
                    <Success>
                      <ConversationAction text="eventtext.cocargobroadcast.receive.accept.answer.lie.success" targettag="listener_player" dialogtype="small" />
                      <ClearTagAction tag="listener_player" />
                      <MissionStateAction missionidentifier="coalition_cargo2" operation="Set" value="2" />
                    </Success>
                    <Failure>
                      <NPCChangeTeamAction npctag="coalitionnpc" teamtag="Team2" />
                      <ConversationAction text="eventtext.cocargobroadcast.receive.accept.answer.lie.failure" targettag="listener_player" dialogtype="small" />
                      <ClearTagAction tag="listener_player" />
                    </Failure>
                  </RNGAction>
                </Success>
                <Failure>
                  <RNGAction chance="0.2">
                    <Success>
                      <ConversationAction text="eventtext.cocargobroadcast.receive.accept.answer.lie.success" targettag="listener_player" dialogtype="small" />
                      <ClearTagAction tag="listener_player" />
                      <MissionStateAction missionidentifier="coalition_cargo2" operation="Set" value="2" />
                    </Success>
                    <Failure>
                      <NPCChangeTeamAction npctag="coalitionnpc" teamtag="Team2" />
                      <ConversationAction text="eventtext.cocargobroadcast.receive.accept.answer.lie.failure" targettag="listener_player" dialogtype="small" />
                      <ClearTagAction tag="listener_player" />
                    </Failure>
                  </RNGAction>
                </Failure>
              </SkillCheckAction>
            </Option>
          </ConversationAction>
        </Option>
        <Option text="eventtext.option.ignore" endconversation="true">
          <NPCChangeTeamAction npctag="coalitionnpc" teamtag="Team2" />
          <ClearTagAction tag="listener_player" />
        </Option>
      </ConversationAction>   
      <!-- experimental: checks if player has crate, adds 1 to crewsuspicious if seen, repeat every second. After X crewsuspicious, enemy team turns hostile again  -->
      <Label name="checkforstolencrate" />
      <WaitAction time="1" />
      <CheckDataAction identifier="crewsuspicious" condition="gt 10">
        <Success>
          <NPCChangeTeamAction npctag="coalitionnpc" teamtag="Team2" />
          <Goto name="end" />
        </Success>
        <Failure>
          <!-- proceed -->
        </Failure>
      </CheckDataAction>
      <CheckItemAction targettag="player" itemtags="coalitioncargo" RequireEquipped="true">
        <Success>
          <CheckVisibilityAction EntityTag="player" TargetTag="coalitionnpc" MaxDistance="500" AllowSameEntity="false">
            <Success>
              <SetDataAction identifier="crewsuspicious" operation="Add" value="1" />
              <GoTo name="checkforstolencrate" />
            </Success>
            <Failure>
              <GoTo name="checkforstolencrate" />
            </Failure>
          </CheckVisibilityAction>  
        </Success>
        <Failure>
          <GoTo name="checkforstolencrate" />
        </Failure>
      </CheckItemAction> 
      <Label name="end" />
    </ScriptedEvent>    

    <!-- TODO test: jettison cargo -->
    <ScriptedEvent identifier="cocargojettison">
      <SpawnAction NPCSetIdentifier="combatmissioncoalitionnpcs" NPCIdentifier="coalitioncaptain" TeamID="FriendlyNPC" />
      <TagAction criteria="player" tag="player" />
      <TagAction criteria="humanprefabidentifier:coalitioncaptain" tag="transmitter" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="humanprefabidentifier:coalitioncaptainlord" tag="transmitter" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="humanprefabidentifier:coalitioncaptain" tag="coalitioncaptain" />
      <TagAction criteria="humanprefabidentifier:coalitioncaptainlord" tag="coalitioncaptain" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="itemtag:jettisonnavterminal" tag="jettisonnavterminal" />
      <TagAction criteria="itemtag:cargodockingport" tag="cargodockingport" />
      <TagAction criteria="itemtag:cargohatch" tag="cargohatch" />
      <WaitAction time="5" />
      <NPCOperateItemAction npctag="coalitioncaptain" targettag="jettisonnavterminal" ItemComponentName="Steering" OrderOption="navigatetodestination" operate="true" />
      <WaitAction time="5" />      
      <ConversationAction text="Engage reverse maneuver! Jettison Cargo!" targettag="player" dialogtype="small" eventsprite="mediator"  ContinueAutomatically="true" endconversation="true"/>
      <WaitAction time="5" />
      <StatusEffectAction targettag="cargohatch">
        <StatusEffect target="This" condition="0" setvalue="true"/>
      </StatusEffectAction>
      <StatusEffectAction targettag="cargodockingport">
        <StatusEffect target="This" docked="false" setvalue="true"/>
      </StatusEffectAction>
      <Label name="end" />
    </ScriptedEvent>    

    
    
    <!-- Coalition Civilian Transport -->
    <ScriptedEvent identifier="cocivtransport">
      <TagAction criteria="player" tag="player" />
      <TagAction criteria="humanprefabidentifier:coalition_civilian_medic" tag="civilian" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="humanprefabidentifier:coalition_civilian_assist" tag="civilian" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="humanprefabidentifier:coalition_civilian_eng" tag="civilian" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="humanprefabidentifier:coalition_civilian_mech" tag="civilian" ContinueIfNoTargetsFound="true" />
      <Label name="restart_cocivtransport" />
      <TriggerAction target1tag="player" target2tag="civilian" applytotarget1="triggerer_player" applytotarget2="triggered_civilian" radius="200" disableincombat="false" disableiftargetincapacitated="true" waitforinteraction="true" allowmultipletargets="true" />
      <NPCChangeTeamAction npctag="triggered_civilian" teamtag="FriendlyNPC" />
      <NPCWaitAction npctag="triggered_civilian" wait="true" />
      <!-- Approach civilian -->
      <ConversationAction text="eventtext.cocivtransport.interact" targettag="triggerer_player" waitforinteraction="true" dialogtype="small">
        <!-- Ask for money -->
        <Option text="eventtext.cocivtransport.option.rob">
          <RNGAction chance="0.5">
            <Success>
              <ConversationAction text="eventtext.cocivtransport.option.rob.answer" targettag="triggerer_player" />
              <MoneyAction amount="238" targettag="triggerer_player" />
              <NPCWaitAction npctag="triggered_civilian" wait="false" />
              <ClearTagAction tag="triggerer_player" />
              <GoTo name="restart_cocivtransport" />
            </Success>
            <Failure>
              <RNGAction chance="0.5">
                <Success>
                  <ConversationAction text="eventtext.cocivtransport.option.rob.answer" targettag="triggerer_player" dialogtype="small" />
                  <MoneyAction amount="397" targettag="triggerer_player" />
                  <NPCWaitAction npctag="triggered_civilian" wait="false" />
                  <ClearTagAction tag="triggerer_player" />
                  <GoTo name="restart_cocivtransport" />
                </Success>
                <Failure>
                  <RNGAction chance="0.5">
                    <Success>
                      <ConversationAction text="eventtext.cocivtransport.option.rob.answer" targettag="triggerer_player" dialogtype="small" />
                      <MoneyAction amount="521" targettag="triggerer_player" />
                      <NPCWaitAction npctag="triggered_civilian" wait="false" />
                      <ClearTagAction tag="triggerer_player" />
                      <GoTo name="restart_cocivtransport" />
                    </Success>
                    <Failure>
                      <RNGAction chance="0.5">
                        <Success>
                          <ConversationAction text="eventtext.cocivtransport.option.rob.answer" targettag="triggerer_player" dialogtype="small" />
                          <MoneyAction amount="873" targettag="triggerer_player" />
                          <NPCWaitAction npctag="triggered_civilian" wait="false" />
                          <ClearTagAction tag="triggerer_player" />
                          <GoTo name="restart_cocivtransport" />
                        </Success>
                        <Failure>
                          <RNGAction chance="0.5">
                            <Success>
                              <ConversationAction text="eventtext.cocivtransport.option.rob.answer" targettag="triggerer_player" dialogtype="small" />
                              <MoneyAction amount="1061" targettag="triggerer_player" />
                              <NPCWaitAction npctag="triggered_civilian" wait="false" />
                              <ClearTagAction tag="triggerer_player" />
                              <GoTo name="restart_cocivtransport" />
                            </Success>
                            <Failure>
                              <ConversationAction text="eventtext.cocivtransport.option.rob.answer" targettag="triggerer_player" dialogtype="small" />
                              <MoneyAction amount="1546" targettag="triggerer_player" />
                              <NPCWaitAction npctag="triggered_civilian" wait="false" />
                              <ClearTagAction tag="triggerer_player" />
                              <GoTo name="restart_cocivtransport" />
                            </Failure>
                          </RNGAction>
                        </Failure>
                      </RNGAction>
                    </Failure>
                  </RNGAction>
                </Failure>
              </RNGAction>
            </Failure>
          </RNGAction>
        </Option>
        <!-- Execute civilian -->
        <Option text="eventtext.cocivtransport.option.execute">
          <ConversationAction text="eventtext.cocivtransport.option.execute.answer" targettag="triggerer_player" dialogtype="small" />
          <AfflictionAction affliction="gunshotwound" strength="100" limbtype="Head" targettag="triggered_civilian" />
          <AfflictionAction affliction="bloodloss" strength="100" limbtype="Torso" targettag="triggered_civilian" />
          <ReputationAction increase="-1" identifier="coalition" targettype="Faction" />
          <NPCWaitAction npctag="triggered_civilian" wait="false" />
          <ClearTagAction tag="triggerer_player" />
          <GoTo name="restart_cocivtransport" />
        </Option>
        <!-- Try to hire -->
        <Option text="eventtext.cocivtransport.option.hire">
          <SkillCheckAction requiredskill="helm" requiredlevel="80" probabilitybased="true" targettag="triggerer_player">
            <Success>
              <RNGAction chance="0.6">
                <Success>
                  <ConversationAction text="eventtext.cocivtransport.option.hire.success" targettag="triggerer_player" dialogtype="small" />
                  <NPCChangeTeamAction npctag="triggered_civilian" teamtag="Team1" addtocrew="true" />
                  <NPCWaitAction npctag="triggered_civilian" wait="false" />
                  <NPCFollowAction npctag="triggered_civilian" targettag="triggerer_player" follow="true" />
                  <ClearTagAction tag="triggerer_player" />
                  <GoTo name="restart_cocivtransport" />
                </Success>
                <Failure>
                  <ConversationAction text="eventtext.cocivtransport.option.hire.failure" speakertag="triggered_civilian" targettag="triggerer_player" dialogtype="small" />
                  <NPCChangeTeamAction npctag="triggered_civilian" teamtag="Team2" />
                  <NPCWaitAction npctag="triggered_civilian" wait="false" />
                  <ClearTagAction tag="triggerer_player" />
                  <GoTo name="restart_cocivtransport" />
                </Failure>
              </RNGAction>
            </Success>
            <Failure>
              <RNGAction chance="0.3">
                <Success>
                  <ConversationAction text="eventtext.cocivtransport.option.hire.success" targettag="triggerer_player" dialogtype="small" />
                  <NPCChangeTeamAction npctag="triggered_civilian" teamtag="Team1" addtocrew="true" />
                  <NPCWaitAction npctag="triggered_civilian" wait="false" />
                  <NPCFollowAction npctag="triggered_civilian" targettag="triggerer_player" follow="true" />
                  <ClearTagAction tag="triggerer_player" />
                  <GoTo name="restart_cocivtransport" />
                </Success>
                <Failure>
                  <ConversationAction text="eventtext.cocivtransport.option.hire.failure" dialogtype="Small" />
                  <NPCChangeTeamAction npctag="triggered_civilian" teamtag="Team2" />
                  <NPCWaitAction npctag="triggered_civilian" wait="false" />
                  <ClearTagAction tag="triggerer_player" />
                  <GoTo name="restart_cocivtransport" />
                </Failure>
              </RNGAction>
            </Failure>
          </SkillCheckAction>
        </Option>
      </ConversationAction>
    </ScriptedEvent>
        
    <!-- OUTPOST TAKEOVER -->
    <!-- TODO: Change takeover to "liberate outpost" when tagging by team becomes possible and replace the removenpc SE with the following one: -->
    <!--
    <StatusEffectAction targettag="removenpc" >
      <StatusEffect target="this" >
        <SpawnItem identifier="handcuffs" spawnposition="ThisInventory" Equip="true" /> 
      </StatusEffect>
    </StatusEffectAction>
    -->
    <!-- Coalition Attackers-->
    <ScriptedEvent identifier="cooutposttakeoverevent">
      <TagAction criteria="player" tag="player" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="bot" tag="bot" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="itemidentifier:dockinghatch" tag="eventstart" submarinetype="Outpost" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="hull" tag="eventstart" submarinetype="Outpost" ContinueIfNoTargetsFound="true" />
      <!-- TODO: remove this when AI is fixed and change to team2 in mission itself -->
      <NPCChangeTeamAction npctag="defenders" teamtag="Team2" />
      <TriggerAction target1tag="player" target2tag="eventstart" radius="100" disableincombat="false" disableiftargetincapacitated="false" waitforinteraction="false" allowmultipletargets="true" />
      <!-- tag and remove security: they are terminators and keep responding to attacks after surrender -->
      <TagAction criteria="humanprefabidentifier:securitynpc" tag="removenpc" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="humanprefabidentifier:securitynpcseparatists" tag="removenpc" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="humanprefabidentifier:securitynpccoalition" tag="removenpc" ContinueIfNoTargetsFound="true" />
      <!-- tag and remove outpost manager (mission giver NPC) since they will not move at all and if the player positions themselves inside of them, the player becomes invincible to enemy AI -->
      <TagAction criteria="humanprefabidentifier:outpostmanagerseparatists" tag="removenpc" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="humanprefabidentifier:outpostmanagercoalition" tag="removenpc" ContinueIfNoTargetsFound="true" />
      <!-- tag and remove watchman (unlock path NPC) since the doors to control room will open automatically -->
      <TagAction criteria="humanprefabidentifier:watchman" tag="removenpc" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="humanprefabidentifier:watchmanseparatist" tag="removenpc" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="humanprefabidentifier:soldierseparatists" tag="defenders" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="jobidentifier:cosoldier" tag="attackers" ContinueIfNoTargetsFound="true" />
      <WaitAction time="1" />
      <StatusEffectAction targettag="removenpc">
        <StatusEffect type="Always" target="Character" interval="1" stackable="false">
          <RemoveCharacter />
        </StatusEffect>
      </StatusEffectAction>
      <ReputationAction targettype="Faction" identifier="separatists" increase="-200" />
      <ConversationAction text="eventtext.takeover.attack" dialogtype="Small" targettag="player" eventsprite="coalition" ContinueAutomatically="true" />
      <Label name="checkforcomplete" />
      <CountTargetsAction targettag="separatistssoldier" CompareToTarget="separatistssoldier" MinPercentageRelativeToTarget="75">
        <!-- complete mission if >75% enemies dead  -->
        <Conditional isdead="True"/>
        <Success>
          <MissionStateAction missionidentifier="cotakeover_separatistoutpost" operation="Set" value="1" />
          <ModifyLocationAction faction="Coalition" />
          <SetDataAction identifier="cotakeoveractive" operation="Set" value="0" />
          <NPCChangeTeamAction npctag="defenders" teamtag="FriendlyNPC" />
          <NPCChangeTeamAction npctag="attackers" teamtag="FriendlyNPC" removefromcrew="true" />
          <CombatAction combatmode="Arrest" npctag="attackers" enemytag="defenders" isinstigator="true" guardreaction="none" witnessreaction="none" />
          <ConversationAction text="eventtext.takeover.success" dialogtype="Mission" targettag="player" eventsprite="Coalition" />
        </Success>
        <Failure>
          <Waitaction time="1" />
          <GoTo name="checkforcomplete" />
        </Failure>
      </CountTargetsAction>
    </ScriptedEvent>
    
    <!-- Separatist Attackers-->
    <ScriptedEvent identifier="sepoutposttakeoverevent">
      <TagAction criteria="player" tag="player" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="bot" tag="bot" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="itemidentifier:dockinghatch" tag="eventstart" submarinetype="Outpost" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="hull" tag="eventstart" submarinetype="Outpost" ContinueIfNoTargetsFound="true" />
      <!-- TODO: remove this when AI is fixed and change to team2 in mission itself -->
      <NPCChangeTeamAction npctag="defenders" teamtag="Team2" />
      <TriggerAction target1tag="player" target2tag="eventstart" radius="100" disableincombat="false" disableiftargetincapacitated="false" waitforinteraction="false" allowmultipletargets="true" />
      <!-- tag and remove security: they are terminators and keep responding to attacks after surrender -->
      <TagAction criteria="humanprefabidentifier:securitynpc" tag="removenpc" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="humanprefabidentifier:securitynpcseparatists" tag="removenpc" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="humanprefabidentifier:securitynpccoalition" tag="removenpc" ContinueIfNoTargetsFound="true" />
      <!-- tag and remove outpost manager (mission giver NPC) since they will not move at all and if the player positions themselves inside of them, the player becomes invincible to enemy AI -->
      <TagAction criteria="humanprefabidentifier:outpostmanagerseparatists" tag="removenpc" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="humanprefabidentifier:outpostmanagercoalition" tag="removenpc" ContinueIfNoTargetsFound="true" />
      <!-- tag and remove watchman (unlock path NPC) since the doors to control room will open automatically -->
      <TagAction criteria="humanprefabidentifier:watchman" tag="removenpc" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="humanprefabidentifier:watchmanseparatist" tag="removenpc" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="humanprefabidentifier:soldiercoalition" tag="defenders" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="jobidentifier:sepsoldier" tag="attackers" ContinueIfNoTargetsFound="true" />
      <WaitAction time="1" />
      <StatusEffectAction targettag="removenpc">
        <StatusEffect type="Always" target="Character" interval="1" stackable="false">
          <RemoveCharacter />
        </StatusEffect>
      </StatusEffectAction>
      <ReputationAction targettype="Faction" identifier="coalition" increase="-200" />
      <ConversationAction text="eventtext.takeover.attack" dialogtype="Small" targettag="player" eventsprite="separatists" ContinueAutomatically="true" />
      <Label name="checkforcomplete" />
      <CountTargetsAction targettag="coalitionsoldier" CompareToTarget="coalitionsoldier" MinPercentageRelativeToTarget="75">
        <!-- complete mission if >75% enemies dead  -->
        <Conditional isdead="True"/>
        <Success>
          <MissionStateAction missionidentifier="septakeover_coalitionoutpost" operation="Set" value="1" />
          <ModifyLocationAction faction="Separatists" />
          <SetDataAction identifier="septakeoveractive" operation="Set" value="0" />
          <NPCChangeTeamAction npctag="defenders" teamtag="FriendlyNPC" />
          <NPCChangeTeamAction npctag="attackers" teamtag="FriendlyNPC" removefromcrew="true" />
          <CombatAction combatmode="Arrest" npctag="attackers" enemytag="defenders" isinstigator="true" guardreaction="none" witnessreaction="none" />
          <ConversationAction text="eventtext.takeover.success" dialogtype="Mission" targettag="player" eventsprite="Separatists" />
        </Success>
        <Failure>
          <Waitaction time="1" />
          <GoTo name="checkforcomplete" />
        </Failure>
      </CountTargetsAction>
    </ScriptedEvent>
        
    <!-- Remove Temporary Crewmembers -->
    <ScriptedEvent identifier="removetempcrew">
      <TagAction criteria="jobidentifier:cosoldier" tag="tempcrew" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="jobidentifier:sepsoldier" tag="tempcrew" ContinueIfNoTargetsFound="true" />
      <NPCChangeTeamAction npctag="tempcrew" teamtag="FriendlyNPC" removefromcrew="true" />
    </ScriptedEvent>   
    
    <!-- TODO: DELETE THIS for takeover testing purposes no touchey until it works -->
    <!-- <ScriptedEvent identifier="takeovertestcoal">
      <MissionAction missionidentifier="cotakeover_separatistoutpost" locationtype="city,research,military,colony,base,blockade,hospital,factory,shipyard" requiredfaction="separatists" minlocationdistance="1" CreateLocationIfNotFound="true" />  
        <SpawnAction NPCSetIdentifier="de_coalitioncombat" NPCIdentifier="tempsoldiercoalition" LootingIsStealing="True" TargetTag="tempcrew" SpawnLocation="Outpost" TeamID="FriendlyNPC" AllowDuplicates="True" />
        <WaitAction time="1" />
        <SpawnAction NPCSetIdentifier="de_coalitioncombat" NPCIdentifier="tempsoldiercoalition" LootingIsStealing="True" TargetTag="tempcrew" SpawnLocation="Outpost" TeamID="FriendlyNPC" AllowDuplicates="True" />
        <WaitAction time="1" />
        <SpawnAction NPCSetIdentifier="de_coalitioncombat" NPCIdentifier="tempsoldiercoalition" LootingIsStealing="True" TargetTag="tempcrew" SpawnLocation="Outpost" TeamID="FriendlyNPC" AllowDuplicates="True" />
        <WaitAction time="1" />
        <SpawnAction NPCSetIdentifier="de_coalitioncombat" NPCIdentifier="tempsoldiercoalition" LootingIsStealing="True" TargetTag="tempcrew" SpawnLocation="Outpost" TeamID="FriendlyNPC" AllowDuplicates="True" />
        <WaitAction time="1" />
        <SpawnAction NPCSetIdentifier="de_coalitioncombat" NPCIdentifier="tempsoldiercoalition" LootingIsStealing="True" TargetTag="tempcrew" SpawnLocation="Outpost" TeamID="FriendlyNPC" AllowDuplicates="True" />
        <TagAction criteria="hullname:airlock" tag="subairlock" submarinetype="Player" ContinueIfNoTargetsFound="true" />
        <NPCFollowAction npctag="tempcrew" targettag="subairlock" follow="true" />
        <WaitAction time="2" />
        <NPCFollowAction npctag="tempcrew" targettag="subairlock" follow="false" />
        <NPCChangeTeamAction npctag="tempcrew" teamtag="Team1" addtocrew="true" />
    </ScriptedEvent> --> 
          
    <ScriptedEvent identifier="lairbombspawn">
      <SpawnAction itemidentifier="de_nuclearbomb" spawnlocation="Mainsub" SpawnPointType="Cargo" TargetTag="lairbomb" offset="0" />
      <EventObjectiveAction type="add" identifier="eventtext.destroylair.reachheart" />
      <EventObjectiveAction type="add" identifier="eventtext.destroylair.plantbomb" />
      <OnRoundEndAction>
        <RemoveItemAction targettag="lairbomb" Amount="100" />
      </OnRoundEndAction>
      <TriggerAction target1tag="lairbomb" target2tag="laircore" radius="500" />
      <EventObjectiveAction type="completeandremove" identifier="eventtext.destroylair.reachheart" />
      <Label name="checkarming" /> 
      <WaitAction time="1" />
      <CheckConditionalAction targettag="lairbomb" targetitemcomponent="LightComponent" IsOn="true">
        <Success>
          <EventObjectiveAction type="completeandremove" identifier="eventtext.destroylair.plantbomb" />
        </Success>
        <Failure>
          <Goto name="checkarming" />                  
        </Failure>
      </CheckConditionalAction>
    </ScriptedEvent>
    
    <ScriptedEvent identifier="vipnappingevent">
      <TagAction criteria="player" tag="player" />
      <TagAction criteria="hull" tag="submarinehull" submarinetype="Player" />
      <TagAction criteria="itemtag:admincabinet" tag="admincabinet" submarinetype="Outpost" />
      <CheckItemAction targettag="ransomtarget" itemidentifiers="idcard" ApplyTagToItem="vipidcard" />
      <!-- allow the npc to open the sub doors and flee back to outpost -->
      <StatusEffectAction targettag="vipidcard">
        <StatusEffect target="this" SubmarineSpecificID="0" setvalue="true" />
      </StatusEffectAction>
      <NPCFollowAction npctag="ransomtarget" targettag="admincabinet" follow="true"/>
      <TriggerAction target1tag="player" target2tag="ransomtarget" applytotarget1="foundvipplayer" radius="200" waitforinteraction="false" />
      <ConversationAction targettag="foundvipplayer" text="eventtext.vipnapping.thatstarget" endeventifinterrupted="false" endconversation="true" dialogtype="small" eventsprite="captain" />
      <TriggerAction target1tag="ransomtarget" target2tag="submarinehull" radius="100" />
      <!-- <OnRoundEndAction>
        <CheckConditionalAction targettag="ransomtarget" InPlayerSubmarine="true" IsDead="False">
          <Success>
          </Success>
          <Failure>
          </Failure>
        </CheckConditionalAction>
      </OnRoundEndAction> -->
      <Label name="end" />
    </ScriptedEvent>
    
    
    <!-- UNUSED. More complex version of ransom, not working currently -->
<!--     <ScriptedEvent identifier="escortransomTEST">    
      <SpawnAction npcsetidentifier="customnpcs" npcidentifier="ransomtarget" spawnlocation="MainSub" />
      <OnRoundEndAction>
        <CheckConditionalAction targettag="ransomtarget" InPlayerSubmarine="true" IsDead="False">
          <Success>
            <SetDataAction identifier="vipnappingnorepeat" value="1" />
            <NPCChangeTeamAction npctag="ransomtarget" teamtag="Team1" addtocrew="true" />
            <TriggerEventAction identifier="escortransom" nextround="true" />
          </Success>
          <Failure>
            <SetDataAction identifier="vipnappingnorepeat" value="1" />
          </Failure>
        </CheckConditionalAction>
      </OnRoundEndAction>
    </ScriptedEvent>
   
    <ScriptedEvent identifier="escortransom">
      <TagAction criteria="jobidentifier:vip" tag="ransomtarget" />
      <NPCChangeTeamAction npctag="ransomtarget" teamtag="Team2" removefromcrew="true" />
      <TagAction criteria="player" tag="player" />
      <TagAction criteria="hull" tag="beaconhull" submarinetype="BeaconStation" />      
      <EventObjectiveAction type="add" identifier="eventtext.escortransom.findbeacon" />
      <TriggerAction target1tag="ransomtarget" target2tag="beaconhull" radius="200" waitforinteraction="false" />
      <EventObjectiveAction type="completeandremove" identifier="eventtext.escortransom.findbeacon" />
      <OnRoundEndAction>        
        <CheckConditionalAction targettag="ransomtarget" InBeaconStation="true" IsDead="False">
          <Success>               
            <MoneyAction amount="2000" />
            <ReputationAction increase="2" identifier="bandits" targettype="Faction" />
          </Success>
          <Failure>
            <NPCChangeTeamAction npctag="ransomtarget" teamtag="Team1" addtocrew="true" />
            <TriggerEventAction identifier="escortransom" nextround="true" />
          </Failure>
        </CheckConditionalAction>
      </OnRoundEndAction>
    </ScriptedEvent>
   
    <ScriptedEvent identifier="missionevent_vipnappingTEST">
      <MissionAction missiontag="vipnapping" locationtype="City,colony,research,hospital,factory,shipyard" requiredfaction="separatists" minlocationdistance="1"/>
    </ScriptedEvent> -->

    
    <!-- TODO:  remove this when devs allow triggering statuseffects in the mission itself just like Escort missions -->
    <ScriptedEvent identifier="huskcrewsymbiosis">
      <TagAction criteria="humanprefabidentifier:huskcultcaptain" tag="huskcrew" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="humanprefabidentifier:huskcultcaptainlord" tag="huskcrew" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="humanprefabidentifier:huskcultsecurityrecruit" tag="huskcrew" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="humanprefabidentifier:huskcultsecurityelite" tag="huskcrew" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="humanprefabidentifier:huskcultengineerrecruit" tag="huskcrew" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="humanprefabidentifier:huskcultengineerveteran" tag="huskcrew" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="humanprefabidentifier:huskcultmechanicrecruit" tag="huskcrew" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="humanprefabidentifier:huskcultmechanicveteran" tag="huskcrew" ContinueIfNoTargetsFound="true" /> 
      <AfflictionAction affliction="husksymbiosis" strength="100" targettag="huskcrew" />
    </ScriptedEvent>   
    
    
    
    <!-- Prototype of an event that spawns enemies outside in lair levels
    TODO - figure out an outpostlevel configuration that doesnt make enemies spawn inside big subs... -->
    
    <ScriptedEvent identifier="laircrawlersoutside">
      <WaitAction time="5" />
      <Label name="loop" />
      <RNGAction chance="0.50"> 
        <Success>
          <CheckDataAction identifier="lairintensity" condition="neq 1">
            <Success>
              <SpawnAction speciesname="crawler" amount="3" SpawnLocation="nearmainsub" offset="500" />
              <SetDataAction identifier="lairintensity" operation="Set" value="1" />
              <WaitAction time="60" />
              <Goto name="loop" />     
            </Success>          
            <Failure>
              <WaitAction time="20" />              
              <SetDataAction identifier="lairintensity" operation="Set" value="0" />       
              <Goto name="loop" />
            </Failure>
          </CheckDataAction>
        </Success>
        <Failure>
          <WaitAction time="5" />
          <Goto name="loop" />
        </Failure>
      </RNGAction>
    </ScriptedEvent>    
    
    <ScriptedEvent identifier="laircrawlersoutside2">
      <SpawnAction speciesname="crawler" amount="3" SpawnLocation="MainPath" offset="500" />
    </ScriptedEvent>
   
    <ScriptedEvent identifier="capturelivecrawlerevent">
      <SetDataAction identifier="capturedlivetarget" operation="set" value="0" />
      <SpawnAction speciesname="Crawler_capture" TargetTag="capturetarget" amount="3" SpawnLocationType="MainPath" offset="500" />
      <TagAction criteria="player" tag="player" />
      <TagAction criteria="hull" tag="playerhull" submarinetype="Player" />
      <TriggerAction target1tag="capturetarget" target2tag="playerhull" radius="50" waitforinteraction="false" />
      <!-- jank way of making a message popup when crawler gets inside -->
      <MissionStateAction missionidentifier="capturelivecrawler" operation="set" value="1" />
      <OnRoundEndAction>
          <CountTargetsAction targettag="capturetarget" hulltag="playerhull" CompareToTarget="capturetarget" MinPercentageRelativeToTarget="1">
          <Conditional IsDead="false" />
          <Success>
            <SetDataAction identifier="capturedlivetarget" operation="set" value="1" />
          </Success>
          <Failure>
            <SetDataAction identifier="capturedlivetarget" operation="set" value="0" />
          </Failure>
        </CountTargetsAction>
      </OnRoundEndAction>
    </ScriptedEvent>

    <ScriptedEvent identifier="industrialincidentevent" commonness="50">
      <TagAction criteria="player" tag="player" />
      <TagAction criteria="itemtag:junctionbox" tag="breakthis" SubmarineType="Outpost" ContinueIfNoTargetsFound="true" chooserandom="true" ChoosePercentage="66" />
      <TagAction criteria="itemtag:fabricator" tag="breakthis" SubmarineType="Outpost" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="itemtag:deconstructor" tag="breakthis" SubmarineType="Outpost" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="itemtag:reactor" tag="damagethis" SubmarineType="Outpost" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="itemtag:oxygengenerator" tag="damagethis" SubmarineType="Outpost" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="itemtag:oxygengenerator" tag="ventthis" SubmarineType="Outpost" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="itemtag:vent" tag="ventthis" SubmarineType="Outpost" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="itemtag:wire" tag="lockthis" SubmarineType="Outpost" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="eventtag:breakthis" tag="repairthis" SubmarineType="Outpost" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="eventtag:damagethis" tag="repairthis" SubmarineType="Outpost" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="eventtag:repairthis" tag="burnthis" SubmarineType="Outpost" ContinueIfNoTargetsFound="true" chooserandom="true" ChoosePercentage="50" />
      <TagAction criteria="itemtag:fireextinguisher" tag="removethis" SubmarineType="Outpost" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="itemtag:mechanicalrepairtool" tag="removethis" SubmarineType="Outpost" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="itemtag:electricalrepairtool" tag="removethis" SubmarineType="Outpost" ContinueIfNoTargetsFound="true" />
      <!-- keep O2 gen running, destroy JBs/Decon/Fabricator, damage O2 generator and reactor, start fires, lock wires, remove extinguishers and repair tools -->
      <StatusEffectAction targettag="breakthis">
        <StatusEffect target="This" condition="0" NonInteractable="false" NonPlayerTeamInteractable="false" setvalue="true" />
      </StatusEffectAction>
      <StatusEffectAction targettag="damagethis">
        <StatusEffect target="This" condition="20" NonInteractable="false" NonPlayerTeamInteractable="false" setvalue="true" />
      </StatusEffectAction>
      <StatusEffectAction targettag="burnthis">
        <StatusEffect target="This" >
          <Fire size="50" />
        </StatusEffect>
      </StatusEffectAction>
      <StatusEffectAction targettag="lockthis">
        <StatusEffect target="This" NonInteractable="true" setvalue="true" />
      </StatusEffectAction>
      <StatusEffectAction targettag="removethis">
        <StatusEffect target="This" >
          <Remove />
        </StatusEffect>
      </StatusEffectAction>
      <!-- check for all damaged items repaired -->
      <Waitaction time="1" />
      <Label name="checkforrepaired" />
      <CountTargetsAction targettag="repairthis" CompareToTarget="repairthis" MinPercentageRelativeToTarget="100">
        <Conditional condition="gte 90" />
        <Failure>
          <!-- keep the vents going for the fire -->
          <StatusEffectAction targettag="ventthis">
            <StatusEffect target="This" duration="2" OxygenFlow="500000" disabledeltatime="true" setvalue="true" />
            <StatusEffect target="This" duration="2" targetitemcomponent="oxygengenerator" GeneratedAmount="10000" setvalue="true" />
          </StatusEffectAction>
          
          <Waitaction time="1" />
          <GoTo name="checkforrepaired" />
        </Failure>
        <Success>
          <SetDataAction identifier="outpostfixed" operation="set" value="1" />
          <MissionStateAction missionidentifier="industrialincident" operation="Set" value="2" />
          <ReputationAction targettype="Location" increase="3" />
          <ConversationAction text="eventtext.industrialincidentevent.success" dialogtype="Mission" targettag="player" eventsprite="officeinside" />
        </Success>
      </CountTargetsAction>
    </ScriptedEvent>
    
    <!-- UNUSED. TODO: rework -->
    <ScriptedEvent identifier="finddocuments" commonness="50">
      <TagAction criteria="player" tag="player" />
      <TagAction criteria="itemidentifier:mediumsteelcabinet" tag="potentialcabinet" SubmarineType="Outpost" ContinueIfNoTargetsFound="true"  />
      <TagAction criteria="itemidentifier:steelcabinet" tag="potentialcabinet" SubmarineType="Outpost" ContinueIfNoTargetsFound="true"  />
      
      <StatusEffectAction targettag="potentialcabinet">
        <StatusEffect target="This" spritecolor="255,0,255,255" setvalue="true" />
      </StatusEffectAction>      
      <Label name="finddocuments1" />
      <TagAction criteria="eventtag:potentialcabinet" tag="documentcabinet1" SubmarineType="Outpost" chooserandom="true" ContinueIfNoTargetsFound="false"  />
      <SpawnAction itemidentifier="documents" targettag="documents1" targetinventory="documentcabinet1" ignorebyai="true" />
      <!-- must pick up bomb to proceed -->
      <TriggerAction target1tag="player" target2tag="documents1" applytotarget1="documents1finder" waitforinteraction="true" />
      <ConversationAction text="You've found documents, but nothing interesting." targettag="documents1finder" eventsprite="BombScare2">
        <Option text="Search elsewhere." endconversation="true"/> 
        <Goto name="finddocuments2" />
      </ConversationAction>      
      <Label name="finddocuments2" />
      <TagAction criteria="eventtag:potentialcabinet" tag="documentcabinet2" SubmarineType="Outpost" chooserandom="true" ContinueIfNoTargetsFound="false"  />
      <SpawnAction itemidentifier="documents" targettag="documents2" targetinventory="documentcabinet2" ignorebyai="true" />
      <!-- must pick up bomb to proceed -->
      <TriggerAction target1tag="player" target2tag="documents2" applytotarget1="documents2finder" waitforinteraction="true" />
      <ConversationAction text="You've found documents, but nothing interesting." targettag="documents2finder" eventsprite="BombScare2">
        <Option text="Search elsewhere." endconversation="true"/> 
        <Goto name="finddocuments3" />
      </ConversationAction>      
      <Label name="finddocuments3" />
      <TagAction criteria="eventtag:potentialcabinet" tag="documentcabinet3" SubmarineType="Outpost" chooserandom="true" ContinueIfNoTargetsFound="false"  />
      <SpawnAction itemidentifier="documents" targettag="documents3" targetinventory="documentcabinet3" ignorebyai="true" />
      <!-- must pick up bomb to proceed -->
      <TriggerAction target1tag="player" target2tag="documents3" applytotarget1="documents3finder" waitforinteraction="true" />
      <ConversationAction text="You've found documents, but nothing interesting." targettag="documents3finder" eventsprite="BombScare2">
        <Option text="Search elsewhere." endconversation="true"/> 
        <Goto name="finddocuments4" />
      </ConversationAction>      
      <Label name="finddocuments4" />
      <TagAction criteria="eventtag:potentialcabinet" tag="documentcabinet4" SubmarineType="Outpost" chooserandom="true" ContinueIfNoTargetsFound="false"  />
      <SpawnAction itemidentifier="classifieddocuments" targettag="documents4" targetinventory="documentcabinet4" ignorebyai="true" />
      <!-- must pick up bomb to proceed -->
      <TriggerAction target1tag="player" target2tag="documents4" applytotarget1="documents4finder" waitforinteraction="true" />
      <ConversationAction text="Those are the documents." targettag="documents4finder" eventsprite="BombScare2">
        <Option text="Back to the ship." endconversation="true"/> 
        <Goto name="finddocuments4" />       
      </ConversationAction>
    </ScriptedEvent>
    
  </EventPrefabs>
</Randomevents>
