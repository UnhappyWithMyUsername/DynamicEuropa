<?xml version="1.0" encoding="utf-8"?>
<Randomevents>
  <!-- Events defined in <EventPrefabs> can only be triggered via a console command or with a TriggerEventAction -->
  <EventPrefabs>
    <!-- OUTPOST TAKEOVER -->
    <ScriptedEvent identifier="cooutposttakeoverevent">
      <TagAction criteria="player" tag="player" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="bot" tag="bot" ContinueIfNoTargetsFound="true" />
      <!-- tag and remove security: they are terminators and keep responding to attacks after surrender -->
      <TagAction criteria="humanprefabidentifier:securitynpc" tag="removenpc" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="humanprefabidentifier:securitynpcseparatists" tag="removenpc" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="humanprefabidentifier:securitynpccoalition" tag="removenpc" ContinueIfNoTargetsFound="true" />
      <!-- tag and remove outpost manager (mission giver NPC) since they will not move at all and if the player positions themselves inside of them, the player becomes invincible to enemy AI -->
      <TagAction criteria="humanprefabidentifier:outpostmanagerseparatists" tag="removenpc" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="humanprefabidentifier:outpostmanagercoalition" tag="removenpc" ContinueIfNoTargetsFound="true" />
      <!-- tag and remove watchman (unlock path NPC) since the doors to control room will open automatically -->
      <TagAction criteria="humanprefabidentifier:watchman" tag="removenpc" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="humanprefabidentifier:watchmanseparatist" tag="removenpc" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="humanprefabidentifier:soldierseparatists" tag="defenders" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="jobidentifier:cosoldier" tag="attackers" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="itemidentifier:dockinghatch" tag="eventstart" submarinetype="Outpost" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="hull" tag="eventstart" submarinetype="Outpost" ContinueIfNoTargetsFound="true" />
      <WaitAction time="1" />
      <StatusEffectAction targettag="removenpc">
        <StatusEffect type="Always" target="Character" interval="1" stackable="false">
          <RemoveCharacter />
        </StatusEffect>
      </StatusEffectAction>
      <!-- TODO: remove this when AI is fixed and change to team2 in mission itself -->
      <NPCChangeTeamAction npctag="defenders" teamtag="Team2" />
      <TriggerAction target1tag="player" target2tag="eventstart" radius="100" disableincombat="false" disableiftargetincapacitated="false" waitforinteraction="false" allowmultipletargets="true" />
      <ReputationAction targettype="Location" increase="-200" />
      <ConversationAction text="eventtext.takeover.attack" dialogtype="Small" targettag="player" eventsprite="coalition" ContinueAutomatically="true" />
      <Label name="checkforcomplete" />
      <CountTargetsAction targettag="separatistssoldier" CompareToTarget="separatistssoldier" MinPercentageRelativeToTarget="75">
        <!-- complete mission if >75% enemies dead  -->
        <Conditional isdead="True"/>
        <Success>
          <MissionStateAction missionidentifier="cotakeover_separatistoutpost" operation="Set" value="1" />
          <ModifyLocationAction faction="Coalition" />
          <SetDataAction identifier="cotakeoveractive" operation="Set" value="0" />
          <NPCChangeTeamAction npctag="defenders" teamtag="FriendlyNPC" />
          <NPCChangeTeamAction npctag="attackers" teamtag="FriendlyNPC" removefromcrew="true" />
          <CombatAction combatmode="Arrest" npctag="attackers" enemytag="defenders" isinstigator="true" guardreaction="none" witnessreaction="none" />
          <ConversationAction text="eventtext.takeover.success" dialogtype="Mission" targettag="player" eventsprite="Coalition" />
        </Success>
        <Failure>
          <Waitaction time="1" />
          <GoTo name="checkforcomplete" />
        </Failure>
      </CountTargetsAction>
    </ScriptedEvent>
    
    <!-- OUTPOST TAKEOVER MISSION -->
    <!-- Coalition Attackers-->
    <ScriptedEvent identifier="cooutposttakeoverevent">
      <TagAction criteria="player" tag="player" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="bot" tag="bot" ContinueIfNoTargetsFound="true" />
      <!-- tag and remove security: they are terminators and keep responding to attacks after surrender -->
      <TagAction criteria="humanprefabidentifier:securitynpc" tag="removenpc" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="humanprefabidentifier:securitynpcseparatists" tag="removenpc" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="humanprefabidentifier:securitynpccoalition" tag="removenpc" ContinueIfNoTargetsFound="true" />
      <!-- tag and remove outpost manager (mission giver NPC) since they will not move at all and if the player positions themselves inside of them, the player becomes invincible to enemy AI -->
      <TagAction criteria="humanprefabidentifier:outpostmanagerseparatists" tag="removenpc" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="humanprefabidentifier:outpostmanagercoalition" tag="removenpc" ContinueIfNoTargetsFound="true" />
      <!-- tag and remove watchman (unlock path NPC) since the doors to control room will open automatically -->
      <TagAction criteria="humanprefabidentifier:watchman" tag="removenpc" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="humanprefabidentifier:watchmanseparatist" tag="removenpc" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="humanprefabidentifier:soldierseparatists" tag="defenders" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="jobidentifier:cosoldier" tag="attackers" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="itemidentifier:dockinghatch" tag="eventstart" submarinetype="Outpost" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="hull" tag="eventstart" submarinetype="Outpost" ContinueIfNoTargetsFound="true" />
      <WaitAction time="1" />
      <StatusEffectAction targettag="removenpc">
        <StatusEffect type="Always" target="Character" interval="1" stackable="false">
          <RemoveCharacter />
        </StatusEffect>
      </StatusEffectAction>
      <!-- TODO: remove this when AI is fixed and change to team2 in mission itself -->
      <NPCChangeTeamAction npctag="defenders" teamtag="Team2" />
      <TriggerAction target1tag="player" target2tag="eventstart" radius="100" disableincombat="false" disableiftargetincapacitated="false" waitforinteraction="false" allowmultipletargets="true" />
      <ReputationAction targettype="Location" increase="-200" />
      <ConversationAction text="eventtext.takeover.attack" dialogtype="Small" targettag="player" eventsprite="coalition" ContinueAutomatically="true" />
      <Label name="checkforcomplete" />
      <CountTargetsAction targettag="separatistssoldier" CompareToTarget="separatistssoldier" MinPercentageRelativeToTarget="75">
        <!-- complete mission if >75% enemies dead  -->
        <Conditional isdead="True"/>
        <Success>
          <MissionStateAction missionidentifier="cotakeover_separatistoutpost" operation="Set" value="1" />
          <ModifyLocationAction faction="Coalition" />
          <SetDataAction identifier="cotakeoveractive" operation="Set" value="0" />
          <NPCChangeTeamAction npctag="defenders" teamtag="FriendlyNPC" />
          <NPCChangeTeamAction npctag="attackers" teamtag="FriendlyNPC" removefromcrew="true" />
          <CombatAction combatmode="Arrest" npctag="attackers" enemytag="defenders" isinstigator="true" guardreaction="none" witnessreaction="none" />
          <ConversationAction text="eventtext.takeover.success" dialogtype="Mission" targettag="player" eventsprite="Coalition" />
        </Success>
        <Failure>
          <Waitaction time="1" />
          <GoTo name="checkforcomplete" />
        </Failure>
      </CountTargetsAction>
    </ScriptedEvent>
    
    <!-- Separatist Attackers-->
    <ScriptedEvent identifier="sepoutposttakeoverevent">
      <TagAction criteria="player" tag="player" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="bot" tag="bot" ContinueIfNoTargetsFound="true" />
      <!-- tag and remove security: they are terminators and keep responding to attacks after surrender -->
      <TagAction criteria="humanprefabidentifier:securitynpc" tag="removenpc" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="humanprefabidentifier:securitynpcseparatists" tag="removenpc" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="humanprefabidentifier:securitynpccoalition" tag="removenpc" ContinueIfNoTargetsFound="true" />
      <!-- tag and remove outpost manager (mission giver NPC) since they will not move at all and if the player positions themselves inside of them, the player becomes invincible to enemy AI -->
      <TagAction criteria="humanprefabidentifier:outpostmanagerseparatists" tag="removenpc" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="humanprefabidentifier:outpostmanagercoalition" tag="removenpc" ContinueIfNoTargetsFound="true" />
      <!-- tag and remove watchman (unlock path NPC) since the doors to control room will open automatically -->
      <TagAction criteria="humanprefabidentifier:watchman" tag="removenpc" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="humanprefabidentifier:watchmanseparatist" tag="removenpc" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="humanprefabidentifier:soldiercoalition" tag="defenders" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="jobidentifier:sepsoldier" tag="attackers" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="itemidentifier:dockinghatch" tag="eventstart" submarinetype="Outpost" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="hull" tag="eventstart" submarinetype="Outpost" ContinueIfNoTargetsFound="true" />
      <WaitAction time="1" />
      <StatusEffectAction targettag="removenpc">
        <StatusEffect type="Always" target="Character" interval="1" stackable="false">
          <RemoveCharacter />
        </StatusEffect>
      </StatusEffectAction>
      <!-- TODO: remove this when AI is fixed and change to team2 in mission itself -->
      <NPCChangeTeamAction npctag="defenders" teamtag="Team2" />
      <TriggerAction target1tag="player" target2tag="eventstart" radius="100" disableincombat="false" disableiftargetincapacitated="false" waitforinteraction="false" allowmultipletargets="true" />
      <ConversationAction text="eventtext.takeover.attack" dialogtype="Small" targettag="player" eventsprite="separatists" ContinueAutomatically="true" />
      <Label name="checkforcomplete" />
      <CountTargetsAction targettag="coalitionsoldier" CompareToTarget="coalitionsoldier" MinPercentageRelativeToTarget="75">
        <!-- complete mission if >75% enemies dead  -->
        <Conditional isdead="True"/>
        <Success>
          <MissionStateAction missionidentifier="septakeover_coalitionoutpost" operation="Set" value="1" />
          <ModifyLocationAction faction="Separatists" />
          <SetDataAction identifier="septakeoveractive" operation="Set" value="0" />
          <NPCChangeTeamAction npctag="defenders" teamtag="FriendlyNPC" />
          <NPCChangeTeamAction npctag="attackers" teamtag="FriendlyNPC" removefromcrew="true" />
          <CombatAction combatmode="Arrest" npctag="attackers" enemytag="defenders" isinstigator="true" guardreaction="none" witnessreaction="none" />
          <ConversationAction text="eventtext.takeover.success" dialogtype="Mission" targettag="player" eventsprite="Separatists" />
        </Success>
        <Failure>
          <Waitaction time="1" />
          <GoTo name="checkforcomplete" />
        </Failure>
      </CountTargetsAction>
    </ScriptedEvent>
        
    <!-- Remove Temporary Crewmembers -->
    <ScriptedEvent identifier="removetempcrew">
      <TagAction criteria="jobidentifier:cosoldier" tag="tempcrew" ContinueIfNoTargetsFound="true" />
      <TagAction criteria="jobidentifier:sepsoldier" tag="tempcrew" ContinueIfNoTargetsFound="true" />
      <NPCChangeTeamAction npctag="tempcrew" teamtag="FriendlyNPC" removefromcrew="true" />
    </ScriptedEvent>   
    
    <!-- TODO: DELETE THIS for takeover testing purposes no touchey until it works -->
    <ScriptedEvent identifier="takeovertestcoal">
      <MissionAction missionidentifier="cotakeover_separatistoutpost" locationtype="city,research,military,colony,base,blockade,hospital,factory,shipyard" requiredfaction="separatists" minlocationdistance="1" CreateLocationIfNotFound="true" />  
        <SpawnAction NPCSetIdentifier="de_coalitioncombat" NPCIdentifier="tempsoldiercoalition" LootingIsStealing="True" TargetTag="tempcrew" SpawnLocation="Outpost" TeamID="FriendlyNPC" AllowDuplicates="True" />
        <WaitAction time="1" />
        <SpawnAction NPCSetIdentifier="de_coalitioncombat" NPCIdentifier="tempsoldiercoalition" LootingIsStealing="True" TargetTag="tempcrew" SpawnLocation="Outpost" TeamID="FriendlyNPC" AllowDuplicates="True" />
        <WaitAction time="1" />
        <SpawnAction NPCSetIdentifier="de_coalitioncombat" NPCIdentifier="tempsoldiercoalition" LootingIsStealing="True" TargetTag="tempcrew" SpawnLocation="Outpost" TeamID="FriendlyNPC" AllowDuplicates="True" />
        <WaitAction time="1" />
        <SpawnAction NPCSetIdentifier="de_coalitioncombat" NPCIdentifier="tempsoldiercoalition" LootingIsStealing="True" TargetTag="tempcrew" SpawnLocation="Outpost" TeamID="FriendlyNPC" AllowDuplicates="True" />
        <WaitAction time="1" />
        <SpawnAction NPCSetIdentifier="de_coalitioncombat" NPCIdentifier="tempsoldiercoalition" LootingIsStealing="True" TargetTag="tempcrew" SpawnLocation="Outpost" TeamID="FriendlyNPC" AllowDuplicates="True" />
        <TagAction criteria="hullname:airlock" tag="subairlock" submarinetype="Player" ContinueIfNoTargetsFound="true" />
        <NPCFollowAction npctag="tempcrew" targettag="subairlock" follow="true" />
        <WaitAction time="2" />
        <NPCFollowAction npctag="tempcrew" targettag="subairlock" follow="false" />
        <NPCChangeTeamAction npctag="tempcrew" teamtag="Team1" addtocrew="true" />
    </ScriptedEvent> 
  </EventPrefabs>
</Randomevents>
